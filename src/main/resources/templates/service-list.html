<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>

<meta charset="UTF-8">
<title>Service List | Children Care From Team2</title>
<!-- responsive meta -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- For IE -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- master stylesheet -->
<link rel="stylesheet" href="../css/style.css">
<!-- Responsive stylesheet -->
<link rel="stylesheet" href="../css/responsive.css">
<!--Color Switcher Mockup-->
<link rel="stylesheet" href="../css/color-switcher-design.css">
<!--Color Themes-->
<link rel="stylesheet" href="../css/color-themes/default-theme.css"
	id="theme-color-file">
<!-- Bootstrap -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
<!-- Bootstrap -->
<!-- Favicon -->
<link rel="apple-touch-icon" sizes="180x180"
	href="../images/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png"
	href="../images/favicon/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png"
	href="../images/favicon/favicon-16x16.png" sizes="16x16">
<link rel="stylesheet" href="../css/service-list.css">
<link rel="stylesheet" href="../css/authentication.css">
 <!-- Fav icon -->	
	<script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>	
</head>

<body th:onload="renderPages()">
	<div id="my-modal-success">
		<div class="my-modal-content">
			<h1>Added successfully <i class="fas fa-check" style="font-size : 20px;"></i></h1>
			<span class="fa fa-close close-modal" onclick="triggerModal('my-modal-success','none')"></span>
		</div>
	</div>
	<div id="my-modal-feedback-step1">
		<div class="my-modal-content container-fluid">
			<h3 style="color : black;" id="feedback-question"></h3>
			<div class="row">
				<div class="col-md-2 feeling" onclick="ratingStar(0)">
					<span class="far fa-dizzy" style="color : #1f0c0c;"></span>
					<p style="color : #1f0c0c;" class="feeling-description">Chán không còn gì để lói</p>
				</div>
				<div class="col-md-2 feeling" onclick="ratingStar(1)">
					<span class="far fa-angry" style="color : #fc0505;"></span>
					<p style="color : #fc0505;" class="feeling-description">Cáu zl</p>
				</div>
				<div class="col-md-2 feeling" onclick="ratingStar(2)">
					<span class="far fa-frown" style="color : #5c5050;"></span>
					<p style="color : #5c5050" class="feeling-description">Thất vọng</p>
				</div>
				<div class="col-md-2 feeling" onclick="ratingStar(3)">
					<span class="far fa-meh" style="color : #91f23d;"></span>
					<p style="color : #91f23d;" class="feeling-description">Tạm OK</p>
				</div>
				<div class="col-md-2 feeling" onclick="ratingStar(4)">
					<span class="far fa-grin-alt" style="color : #3b7ded;"></span>
					<p style="color : #3b7ded" class="feeling-description">Hài lòng</p>
				</div>
				<div class="col-md-2 feeling" onclick="ratingStar(5)">
					<span class="far fa-grin-beam" style="color : #00d157;"></span>
					<p style="color : #00d157" class="feeling-description">Rất hài lòng lun! </p>
				</div>
			</div>
			<div class="my-modal-chaining">
				<button class="btn btn-success" disabled="disabled" id="next-button" onclick="startFormFeedback()">
				  <i class="fas fa-arrow-right">Next</i> 
				</button>
			</div>
			<span class="fa fa-close close-modal" onclick="triggerModal('my-modal-feedback-step1','none')"></span>
		</div>
	</div>
	<div id="my-modal-feedback-step-2">
		<div class="my-modal-content" >
			<label for="image-feedback-input" class="modal-label">Show your image feedback :</label>
			<input type="file" id="image-feedback-input" class="form-control modal-input" style="font-size : 13px;padding : 5px;" onchange="imagePreviewHandler(this)"/>
			<img class="modal-image-feedback"/>
			<label for="comment" class="modal-label">Give your comment here : </label>
			<textarea rows="10" cols="50" id="comment" class="form-control modal-input" placeholder="Commenting...." style="font-size : 15px;padding : 5px;"></textarea>
			<button class="btn btn-primary save-feedback" 
				style="font-size: 25px;border-radius: 9px;" onclick="saveFeedback()">
			    Save your feedback
			</button>
			<span class="fa fa-close close-modal" onclick="triggerModal('my-modal-feedback-step-2','none')"></span>
		</div>
	</div>
	<div id="my-modal-contact-menu">
		<div class="my-modal-content">
			<h1 class="modal-header">Do we know you?</h1>
			<ul class="list-group">
				<li class="list-group-item"><a href="#" class="modal-contact-link" onclick="startLoginForm()">Login</a></li>
				<li class="list-group-item"><a href="#" class="modal-contact-link" onclick="startContactModal(event)">Give your contact here!</a> </li>
			</ul>
			<span class="fa fa-close close-modal" onclick="triggerModal('my-modal-contact-menu','none')"></span>
		</div>
	</div>

	<div id="my-modal-waiting">
		<div class="my-modal-content">
			<i class="fas fa-circle-notch fa-spin" style="font-size : 50px;color : green;"></i>
		</div>
	</div>
	
	<div id="my-modal-contact">
		<div class="my-modal-content">
			<h1 class="modal-header">Contact</h1>
			<div class="form-group email">
				<label for="user-email" class="modal-label">Email</label>
				<input type="text" class="form-control modal-input" placeholder="Put your email..." id="user-email" onkeyup="verifyUserEmail(this.value)"/>
				<span id="email-verification-message"></span>
			</div>	
			<h5 id="contact-message"></h5>
			<button class="btn btn-danger" id="verify-contact-button" onclick="identifyUserContact()" disabled="disabled">Verify your contact <span id="verify-contact-icon" class="fas fa-exclamation"></span></button>
			<span class="fa fa-close close-modal" onclick="triggerModal('my-modal-contact','none')"></span>
		</div>
	</div>
	
	<div id="my-modal-identification">
		<div class="my-modal-content">
			<h1 class="modal-header" id="modal-header-counter"></h1>
			<label for="answer" id="label-answer">Your answer : </label>
			<input type="text" class="form-control modal-input" placeholder="Put your answer..." id="answer"/>
			<button class="btn btn-primary" onclick="indentifyCaptchaCode()" id="verify-email" disabled="disabled">Verify</button>
		</div>
	</div>
	
	<div class="boxed_wrapper" th:replace="authentication.html :: authentication('/service/services')"></div>
	
	<div id="top-bar" th:insert="index :: top-bar"></div>
	<header th:replace="header.html :: header"></header>
	<section id="main-menu" 
	th:replace="mainmenu.html :: mainMenu(actionForm='/ChildrenCare/service/services', placeholder='Search By Title ...',current='services',search=${search})">
	</section>
	
	<!-- start hidden fields -->
	<input type="hidden" th:value="${totalPages}" id="totalPages" />
	<input type="hidden" th:value="${categoryId}" id="categoryId"/>
	<input type="hidden" th:value="${currentPage}" id="currentPage"/>
	<!-- end hidden fields -->
	
	<div id="body" class="container-fluid">
		<div class="row">
			<div class='col-sm-3 service-item pl-0 pr-0' th:each="service : ${services}"
				th:onclick="'viewServiceDetails(event,'+${service.serviceId}+')'"
				th:onmouseover="'triggerToolTips('+ ${service.serviceId} +',\'inline\')'"
				th:onmouseout="'triggerToolTips('+ ${service.serviceId} +',\'none\')'"
				>
				<span class="service-tooltip" 
					th:id="'serviceToolTip' + ${service.serviceId}">Xem chi tiết dịch vụ</span>
				<img
					th:src="${'data:image/gif;base64,'+service.base64ThumbnailEncode}"
					class="service-thumbnail" />
				<h1 th:text="${'Title : '+service.title}" class="service-title"></h1>
				<p th:text="${'Brief Info : '+service.briefInfo}"></p>
				Price : 
				<span th:text="${#numbers.formatDecimal(service.originalPrice,1,'POINT',0,'POINT')}" style="color : black; text-decoration: line-through;"></span>
				<span th:text="${#numbers.formatDecimal(service.salePrice,1,'POINT',0,'POINT')}" style="color : red; font-size : 21px; font-weight: bold;"> </span>
				<div>
					Rated Stars : <span
						th:class="${service.avg_star > 0  ? (service.avg_star < 1 ?  'fas fa-star-half-alt  rated' : 'fas fa-star rated') : 'far fa-star rated'}"></span>
					<span
						th:class="${service.avg_star > 1  ? (service.avg_star < 2 ?  'fas fa-star-half-alt  rated' : 'fas fa-star rated') : 'far fa-star rated'}"></span>
					<span
						th:class="${service.avg_star > 2  ? (service.avg_star < 3 ?  'fas fa-star-half-alt  rated' : 'fas fa-star rated') : 'far fa-star rated'}"></span>
					<span
						th:class="${service.avg_star > 3  ? (service.avg_star < 4 ?  'fas fa-star-half-alt  rated' : 'fas fa-star rated') : 'far fa-star rated'}"></span>
					<span
						th:class="${service.avg_star > 4  ? (service.avg_star < 5 ?  'fas fa-star-half-alt  rated' : 'fas fa-star rated') : 'far fa-star rated'}"></span>
					<h5 th:text="${service.avg_star != -1} ? '    '+${#numbers.formatDecimal(service.avg_star,1,'POINT',1,'POINT')} + ' /5' : 'NO VOTE'"></h5>
				</div>
				<h4 th:text="'Category  :   '+${service.serviceCategory.serviceCategoryName}" style="margin-top : 8px;margin-bottom : 8px;"></h4>
					<div>
						<span class="fas fa-shopping-cart"
							 th:onclick="'addReservationService(event,'+${service.serviceId}+')'">
							 <span style="font-size : 20px;"> ADD TO CART </span>
						</span>
					</div>	
				<div>
					<span>
						<button class="btn btn-success" th:data-serviceTitle="${service.title}" th:data-serviceId="${service.serviceId}"
						th:onclick="startFeedback(this.getAttribute('data-serviceTitle'),this.getAttribute('data-serviceId'))" 
						id="give-feedback-button"><i class="fas fa-comments"></i>Give Feedback</button>
					</span>
				</div>	
			</div>
		</div>
	</div>
	<div id="pages"></div>
	<div id="footer" th:insert="index :: footer"></div>
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="../js/pagging.js"></script>
	<script type="text/javascript">

	var lastChosenFeelingElement;
	var lastChosenFeeling = -1;
	var lastChosenPreview;
	var lastChosenServiceId = -1;
	var captchaInterval;
	var lastChosenModal;
	
	function triggerToolTips(serviceToopTipId,displayProperty){
		var serviceToolTipElement = document.getElementById("serviceToolTip"+serviceToopTipId);
		serviceToolTipElement.style.display = displayProperty; 
	}
	
	function verifyUserEmail(email){
		const userEmailInput = document.getElementById("user-email");
		const userEmailVerificationMessage = document.getElementById("email-verification-message");
		const buttonVerifyingContact = document.getElementById("verify-contact-button");
		const iconVerifyingContact = document.getElementById("verify-contact-icon");
		if(/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(email)){
			userEmailInput.className = "form-control modal-input valid";
			userEmailVerificationMessage.innerHTML = "Email is valid";
			userEmailVerificationMessage.style.color = "green";
			buttonVerifyingContact.disabled = false;
			buttonVerifyingContact.className = "btn btn-success";
			iconVerifyingContact.className = "fas fa-check";
		}else if(userEmailInput.className !== "form-control modal-input invalid"){
			userEmailInput.className = "form-control modal-input invalid";
			userEmailVerificationMessage.innerHTML = "Email is invalid , re-enter your email";
			userEmailVerificationMessage.style.color = "red";
			buttonVerifyingContact.disabled = true;
			buttonVerifyingContact.className = "btn btn-danger";
			iconVerifyingContact.className = "fas fa-exclamation";
		}
	}
	
	function triggerModal(modalId,displayStyle){
		const getModalById = document.getElementById(modalId);
		if(lastChosenFeelingElement){
			lastChosenFeelingElement.className = "col-md-2 feeling";
		}  // clear the last chosen feeling
		
		if(displayStyle !== "none"){
			lastChosenModal = getModalById;
		}else{
			lastChosenModal = null;
		}
		getModalById.style.display = displayStyle;
	}
	
	function startFeedback(title,serviceId){
		fetch("/ChildrenCare/api-feedback/user-email")
		.then(response => response.text())
		.then(email => {
			if(email === 'not yet'){
				triggerModal("my-modal-contact-menu","block");
				return;
			}
			lastChosenServiceId = serviceId;
			
			
			fetch("/ChildrenCare/api-service/get-user-services?serviceId="+serviceId)
			.then(response => response.json())
			.then(feedbacks => {
				if(feedbacks.length == 0){
					alert("Sorry,you have not bought this service.Please buy this service first");	
				}else{
					var feedBackQuestionElement = document.querySelector("#feedback-question");
					feedBackQuestionElement.innerHTML = "Bạn cảm thấy như thế nào về dịch vụ "+ title  +"? ";
					triggerModal("my-modal-feedback-step1","block");
				}
			})
		})
	}
	
	function startLoginForm(){
	/*	$('#tab1').on('click' , function(){
	        $('#tab1').addClass('login-shadow');
	        $('#tab2').removeClass('signup-shadow');
	    }); */
	    triggerModal("my-modal-contact-menu","none");
	    
	    const modalBoxWrapper = document.getElementsByClassName('boxed_wrapper')[0];
	    modalBoxWrapper.style.display = "block";
	    
	    const triggerLoginForm = document.getElementById("trigger-login-form");
	    triggerLoginForm.click();
	}
	
	function triggerLoginForm(displayStyle){
		const modalBoxWrapper = document.getElementsByClassName('boxed_wrapper')[0];
	    modalBoxWrapper.style.display = displayStyle;
	}
	
	function startContactModal(event){
		event.preventDefault();
		triggerModal("my-modal-contact-menu","none");
		
		// Triggering modal contact
		triggerModal("my-modal-contact","block");	
	}
	
	
	function startFormFeedback(){
		triggerModal("my-modal-feedback-step1","none");
		triggerModal("my-modal-feedback-step-2","block");
	}
	
	function saveFeedback(){
		var imageFileFeedback = document.getElementById("image-feedback-input").files[0];
		var commentFeedback = document.getElementById("comment").value;
		 var formData = new FormData();
		formData.append("imageFeedback",imageFileFeedback);
		formData.append("commentFeedback",commentFeedback);
		formData.append("ratedStar",lastChosenFeeling + "");
		formData.append("serviceId",lastChosenServiceId);  
		
		// POST THE FORM TO API 
		fetch("/ChildrenCare/api-feedback/save-feedback" , {
			method : 'POST',
			body : formData
		})
		.then(response => response.text())
		.then(message => {
			if(message !== "success"){
				alert(message);	
			}else{
				// display modal success
				triggerModal("my-modal-success","block");
				setTimeout(() => {
					window.location.reload();
				},2000)
			}
		})
	}

	function viewServiceDetails(event, service_id) {
		if (event.target.tagName !== "SPAN" && event.target.id !== 'give-feedback-button'
			||event.target.className === "service-tooltip"	) { // EXPLANATION : DIV ONCLICK EVENT WILL ALSO BE TRIGGERD WHEN CLICK SPAN INSIDE IT
			window.location = "/ChildrenCare/service/services/" + service_id;
		}
	}
	
	function indentifyCaptchaCode(){
		
		var captcha = document.getElementById("answer").value;
		var email = document.getElementById("user-email").value;
		
		var formData = new FormData();
		formData.append("email",email);
		formData.append("captcha",captcha);
		
		// Display waiting modal to wait for fetching api-feedback
		triggerModal("my-modal-waiting","block");
		
		fetch("/ChildrenCare/api-feedback/verify-captcha" , {
			method : 'POST',
			body : formData
		})
		.then(response => {
			triggerModal("my-modal-waiting","none");
			return response.text();
		})
		.then(message => {
			if(message === "success"){
				clearInterval(captchaInterval);
				alert("We have known you, now you can feedback on any service that you have bouught");
				document.location.reload();
			}else if(message === "fail"){
				alert("Wrong captcha code!!!!");
			}else{
				alert("You are already in the system");  // WHEN USER TRYING TO OPEN VERIFYING CAPTCHACODE MODAL
			}
		})
	}
	
	function identifyUserContact(){
		triggerModal("my-modal-contact","none");
		var email = document.getElementById("user-email").value;
		var formData = new FormData();
		formData.append("email",email);
		fetch("/ChildrenCare/api-feedback/identify-user-email?email="+email)
		.then(response => response.text())
		.then(message => {
			if(message !== "not exsist"){
				// Display waiting modal to wait for fetching api-feedback
				triggerModal("my-modal-waiting","block");
				fetch("/ChildrenCare/api-feedback/generate-captcha" , {
					method : 'POST',
					body : formData
				})
				.then(response => {
					triggerModal("my-modal-waiting","none");
					return response.text();
				})
				.then(captcha => {
					if(captcha !== "verified"){
						var counter = 90;
						var verifyEmail = document.getElementById("verify-email");
						verifyEmail.disabled = false;
						triggerModal("my-modal-identification","block");
						var modalHeaderCounter = document.getElementById("modal-header-counter");
						captchaInterval = setInterval(() => {
							modalHeaderCounter.innerHTML = "We have sent you an catpcha code to your email to verify. Code will be expired in :  "+ generateRealTime(counter);
							if(counter == 0){
								clearInterval(captchaInterval);
								if(confirm("Captcha code is expired , Do you want to receive another captcha? ")){
									identifyUserContact();
								}else{
									triggerModal("my-modal-identification","none");
								}
							}
							counter -= 1;
						},1500)
					}else{
						alert("We have known you , now you can feedback on the services that you have bought!!!");
						document.location.reload();
					}
				})
			}else{
				alert("Your email is not in our database");
			} 
		})
	}
	
	function generateRealTime(seconds){
		var minute = Math.floor(seconds / 60);
		var second = Math.floor(seconds % 60);
		
		var result = (minute < 10) ? "0" + minute : minute;
		result += " : ";
		result += (second < 10) ? "0" + second : second;
		return result;
	}
	
	
	function imagePreviewHandler(fileInputElement){
		if(lastChosenPreview){ 
			URL.revokeObjectURL(lastChosenPreview);  // for performance
		}
		
		var imageFile = fileInputElement.files[0];
		lastChosenPreview = URL.createObjectURL(imageFile);
		var imageFeedbackTag = document.getElementsByClassName("modal-image-feedback")[0];
		imageFeedbackTag.src = lastChosenPreview;
	}
	
	function ratingStar(ratedStar){
		if(lastChosenFeelingElement){
			lastChosenFeelingElement.className = "col-md-2 feeling";
		}
		
		lastChosenFeelingElement = document.getElementsByClassName("feeling")[ratedStar];
		lastChosenFeeling = ratedStar;
		lastChosenFeelingElement.className = 'col-md-2 feeling chosen';
		
		var nextButton = document.getElementById("next-button");
		nextButton.disabled = false;
	}

	function addReservationService(event,service_id) {
		var url = "/ChildrenCare/api-reservation/add/"+service_id;
		fetch(url)
		.then(response => response.json())
		.then(data => {
			var shoppingItemsElement = document.querySelector("span#shopping-cart-items");
			var shoppingItems = data.length;
			shoppingItemsElement.innerHTML = shoppingItems;
			triggerModal("my-modal-success","block");
			setTimeout(() => {
				triggerModal("my-modal-success","none");
			},2000)
		})
	}
	
	window.onclick = (event) => {
		if(!lastChosenModal) return;
		var modalElements = ["my-modal-content","give-feedback-button","next-button","col-md-2 feeling","col-md-2 feeling chosen","feeling-description",
			"far fa-dizzy" , "far fa-angry" , "far fa-frown" , "far fa-meh" , "far fa-grin-alt" , "far fa-grin-beam" , "fas fa-arrow-right" ,
			"modal-image-feedback" , "modal-label" , "form-control modal-input" , "save-feedback" 
			,"list-group","list-group-item","modal-contact-link" , "fa fa-close close-modal" , 
			"modal-header" , "answer" , "verify-email" , "label-answer" , 
			"verify-contact-icon" , "verify-contact-button" , "user-email"]; 
		for(let i = 0 ; i < modalElements.length ; i++){
			const modalElement = modalElements[i];
			if(event.target.className === modalElement || event.target.id === modalElement){
				return;
			}
		}		
		var nextButton = document.getElementById("next-button"); 
		nextButton.disabled = true; // whenever user close feeling modal , disable next button
			
		if(lastChosenPreview && lastChosenModal.id == "my-modal-feedback-step-2"){ 
			URL.revokeObjectURL(lastChosenPreview);  // for performance
		} // clear the last preview
		
		if(lastChosenModal.id == "my-modal-identification"){
			clearInterval(captchaInterval);
		}
			
		// close the modal when user click outside of the modal
		triggerModal(lastChosenModal.id,"none");
	}
	
	function changePage(pageNumber) {
		var search = document.querySelector("#search").value;
		var categoryId = parseInt(document.querySelector("#categoryId").value);
		window.location = "/ChildrenCare/service/services?page=" + pageNumber
				+ "&search=" + search + "&category=" + categoryId;
	}

</script>
</body>
</html>